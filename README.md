# Messenger
# Руководство по редактированию локального мессенджера


Этот документ предназначен для разработчиков, которые планируют дорабатывать, расширять или поддерживать проект локального мессенджера на HTML/JS + Node.js.


## 1. Общая архитектура

Проект состоит из двух основных частей:

- **Клиентская часть** (`/client`): HTML, CSS, JavaScript для интерфейса пользователя.
- **Серверная часть** (`/server`): Node.js‑приложение с Express и Socket.IO для обработки соединений и передачи данных.

Взаимодействие осуществляется через WebSocket (Socket.IO), что обеспечивает мгновенную доставку сообщений и файлов.

## 2. Структура проекта


```
/messenger
  /client
    index.html          # Основная страница интерфейса
    style.css           # Стили оформления
    script.js            # Клиентский JS-код
    /uploads             # Папка для принятых файлов (создаётся автоматически)
  /server
    server.js           # Основной серверный скрипт
  package.json          # Зависимости и настройки npm
```

## 3. Зависимости и запуск

### Требования
- Node.js (версия 14+)
- npm (идёт в комплекте с Node.js)

### Установка и запуск
1. Перейдите в корневую папку проекта:
   ```bash
   cd /путь/к/messenger
   ```
2. Установите зависимости:
   ```bash
   npm install
   ```
3. Запустите сервер:
   ```bash
   npm start
   ```
4. Откройте в браузере: `http://localhost:3000`

## 4. Ключевые механизмы

### 4.1. Обмен сообщениями
- Клиент отправляет сообщение через `socket.emit('send_message', data)`.
- Сервер сохраняет сообщение в массив `messages` и рассылает всем подключённым клиентам через `io.emit('new_message', data)`.
- Клиенты отображают новое сообщение через обработчик `socket.on('new_message', addMessage)`.

### 4.2. Передача файлов
- Файл читается на клиенте через `FileReader` и отправляется в виде Data URL.
- Сервер сохраняет файл в папку `/client/uploads` с оригинальным именем.
- Клиенты получают ссылку на файл (`/uploads/имя_файла`) и отображают её как скачиваемую ссылку.

### 4.3. История сообщений
- При подключении клиент получает всю историю через событие `load_messages`.
- История хранится в оперативной памяти сервера (массив `messages`). *Внимание:* при перезапуске сервера история сбрасывается.

## 5. Точки для доработки


### 5.1. Хранение истории
**Проблема:** история удаляется при перезапуске сервера.  
**Решение:** добавить базу данных (например, SQLite, MongoDB) для перманентного хранения сообщений.

**Что менять:**
- В `server.js`: добавить подключение к БД и операции `saveMessage()`, `loadMessages()`.
- В обработчиках `send_message` и `load_messages`: заменить работу с массивом `messages` на вызовы к БД.


### 5.2. Аутентификация пользователей
**Проблема:** нет идентификации пользователей.  
**Решение:** ввести логин/пароль или токены.

**Что менять:**
- Добавить форму входа на `index.html`.
- В `server.js`: проверять логин/пароль при подключении, присваивать пользователю уникальный ID.
- В сообщениях: добавлять поле `userId` для идентификации автора.


### 5.3. Групповые чаты
**Проблема:** один общий чат.  
**Решение:** реализовать комнаты (channels) через Socket.IO Rooms.

**Что менять:**
- В `server.js`: использовать `socket.join(roomName)` и `io.to(roomName).emit()`.
- В интерфейсе: добавить выбор комнаты и список доступных чатов.

### 5.4. Безопасность
**Проблемы:**  
- Нет проверки типов файлов (можно загрузить вредоносный скрипт).  
- Нет ограничения на размер файлов.

**Решения:**
- В `server.js`:  
  - Проверять MIME‑тип файла перед сохранением.  
  - Ограничивать размер через `if (data.file.length > MAX_SIZE) return`.
- На клиенте: скрывать загрузку файлов неподдерживаемых типов.

### 5.5. Интерфейс
**Возможные улучшения:**
- Добавить аватарки пользователей.
- Реализовать редактирование/удаление сообщений.
- Добавить уведомления о новых сообщениях.
- Сделать адаптивный дизайн для мобильных устройств.

## 6. API Socket.IO

### События от клиента
- `'send_message'`: отправка текстового сообщения.  
  Данные: `{ type: 'text', text: '...', timestamp: '...' }`.
- `'send_file'`: отправка файла.  
  Данные: `{ filename: '...', file: 'data:url...' }`.

### События от сервера
- `'load_messages'`: передача истории при подключении.  
  Данные: массив сообщений.
- `'new_message'`: новое сообщение для всех клиентов.  
  Данные: объект сообщения.

## 7. Логирование и отладка

### Сервер
- Логи выводятся в консоль при запуске `npm start`.
- Для детальной отладки добавьте `console.log()` в обработчики Socket.IO.

### Клиент
- Откройте DevTools (F12) → вкладка «Console».
- Проверьте соединения WebSocket: DevTools → «Network» → фильтр «websocket».

## 8. Локальная сеть

1. Убедитесь, что сервер доступен в LAN (не используйте `localhost`).
2. Узнайте IP сервера в сети (например, `192.168.1.100`).
3. Пользователи подключаются по адресу: `http://192.168.1.100:3000`.

**Примечание:** если порт `3000` заблокирован, измените его в `server.js` (строка `server.listen(3000, ...)`) и перезапустите сервер.

## 9. Лимиты и ограничения

- **Файлы:** сохраняются в `/client/uploads` без проверки типа/размера.
- **Память:** история сообщений хранится в ОЗУ сервера.
- **Масштабируемость:** подходит для 10–20 пользователей в локальной сети.
- **Безопасность:** нет шифрования (данные передаются в открытом виде).

## 10. Рекомендации по расширению

1. **Для устойчивости:** добавьте обработку ошибок в `fs.writeFile()` и Socket.IO‑события.
2. **Для производительности:** используйте Redis для хранения истории вместо массива.
3. **Для UX:** реализуйте «печатает...» (typing indicators) через дополнительные Socket.IO‑события.
4. **Для мобильности:** создайте PWA‑версию (Progressive Web App) с офлайн‑доступом к истории.
